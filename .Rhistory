library(Seurat)
library(BPCells)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(patchwork)
# set this option when analyzing large datasets
options(future.globals.maxSize = 3e9)
remotes::install_github("bnprks/BPCells/r")
remotes::install_github("bnprks/BPCells/r")
parse.mat <- open_matrix_dir(dir = "/brahms/hartmana/vignette_data/bpcells/parse_1m_pbmc")
# need to move
metadata <- readRDS("/brahms/haoy/vignette_data/ParseBio_PBMC_meta.rds")
object <- CreateSeuratObject(counts = parse.mat, meta.data = metadata)
object <- NormalizeData(object)
# split assay into 24 layers
object[['RNA']] <- split(object[['RNA']], f = object$sample)
object <- FindVariableFeatures(object, verbose = FALSE)
library(Seurat)
library(BPCells)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(patchwork)
# set this option when analyzing large datasets
options(future.globals.maxSize = 3e9)
library(MAST)
BiocManager::install("MAST")
BiocManager::install("MAST")
log(5)
log10(0.05)
-log10(0.05)
-log10(0.01)
-log10(0.001)
-log10(0.00001)
log2(2)
log2(3)
log2(4)
log2(16)
log2(0.5)
log2(1)
log2(2)
log2(1.2)
log2(1.1)
log2(1.15)
log2(1.2)
library(Seurat)
library(SeuratData)
library(ggplot2)
ifnb <- LoadData("ifnb")
ifnb <- LoadData("ifnb")
install.packages("imager")
df <- read.table("E:/bin/colorCode/Color_code_chart.tsv", head=T, sep="\t")
View(df)
df <- read.table("E:/bin/colorCode/Color_code_chart.tsv", head=T, sep="\t", comment.char = "")
View(df)
df$colorCode <- paste0("\"", df$colorCode, "\"")
View(df)
write.table(df, "E:/bin/colorCode/Color_code_chart.txt", sep="\t", row.names=F)
df <- read.table("E:/bin/colorCode/Color_code_chart.tsv", head=T, sep="\t", comment.char = "")
#df$colorCode <- paste0("\"", df$colorCode, "\"")
write.table(df, "E:/bin/colorCode/Color_code_chart.txt", sep="\t", row.names=F)
df <- read.table("E:/bin/colorCode/brainRegion_colorCode.tsv", head=T, sep="\t", comment.char = "")
write.table(df, "E:/bin/colorCode/Color_code_chart.txt", sep="\t", row.names=F)
write.table(df, "E:/bin/colorCode/brainRegion_colorCode.txt", sep="\t", row.names=F)
df <- read.table("E:/bin/colorCode/brainRegion_colorCode.tsv", head=T, sep="\t", comment.char = "")
write.table(df, "E:/bin/colorCode/brainRegion_colorCode.txt", sep="\t", row.names=F)
df <- read.table("E:/bin/colorCode/brainRegion_colorCode.tsv", head=T, sep="\t", comment.char = "")
write.table(df, "E:/bin/colorCode/brainRegion_colorCode.txt", sep="\t", row.names=F)
df <- read.table("E:/bin/colorCode/clusterID_colorColde.tsv", head=T, sep="\t", comment.char = "")
#df$colorCode <- paste0("\"", df$colorCode, "\"")
write.table(df, "E:/bin/colorCode/clusterID_colorColde.txt", sep="\t", row.names=F)
df <- read.table("E:/bin/colorCode/clusterID_colorCode.tsv", head=T, sep="\t", comment.char = "")
#df$colorCode <- paste0("\"", df$colorCode, "\"")
write.table(df, "E:/bin/colorCode/clusterID_colorCode.txt", sep="\t", row.names=F)
View(df)
df
#df$colorCode <- paste0("\"", df$colorCode, "\"")
write.table(df, "E:/bin/colorCode/clusterID_colorCode.txt", sep="\t", row.names=F)
df <- read.table("E:/Project/MaLab/MaLab_mouseBrainSpatial/ANALYSIS/singleCell/IntegrateAnalysis/AP93/AP93_SC_res2_clusters_filteredDEGresults.tsv", head=T, sep="\t")
library(dplyr)
subDF <- df %>% group_by("res2_clusters") %>% arrange(desc(avg_log2FC)) %>% as.data.frame()
View(subDF)
subDF <- subDF %>% group_by(("res2_clusters")) %>% slice_head(n=100)
subDF <- df %>% group_by("res2_clusters") %>% arrange(desc(avg_log2FC)) %>% as.data.frame()
subDF <- subDF %>% group_by(("res2_clusters")) %>% slice_head(n=100, .by_group=TRUE)
View(df)
subDF <- df %>% arrange("res2_clusters", desc(avg_log2FC))
subDF <- subDF %>% group_by("res2_clusters") %>% slice_head(n = 100) %>% ungroup() %>% as.data.frame()
View(subDF)
subDF <- df %>%
arrange(res2_clusters, desc(avg_log2FC)) %>%
group_by(res2_clusters) %>% slice_head(n=100)
View(subDF)
subDF <- df %>%
arrange(res2_clusters, desc(avg_log2FC)) %>%
group_by(res2_clusters) %>% slice_head(n=50)
subDF <- df %>%
arrange(res2_clusters, desc(avg_log2FC)) %>%
group_by(res2_clusters) %>% slice_head(n=50) %>%
select(res2_clusters, gene)
View(subDF)
write.table(subDF, "E:/Project/MaLab/MaLab_mouseBrainSpatial/ANALYSIS/singleCell/IntegrateAnalysis/AP93/AP93_SC_res2_clusters_top50_DEGs.tsv", sep="\t", quote=F, row.names=F)
?install.packages()
.libPaths()
library(dplyr)
library(cowplot)
library(ggplot2)
?plot_grid
library(Seurat)
?RunUMAP
?FindNeighbors
?FindClusters
aa <- load("E:/bin/colorCode/chinacolor.rda")
aa
aa <- load("E:/bin/colorCode/chinacolor_palette_list.rda")
remotes::install_github("zhiming-chen/chinacolor")
remotes::install_github("zhiming-chen/chinacolor")
remotes::install_github('rstudio/DT')
library(shiny)
library(shinydashboard)
install.packages("shinydashboard")
library(shiny)
library(shinydashboard)
library(DT)
library(plotly)
library(dplyr)
library(ggplot2)
library(readr)
# å‡½æ•°ï¼šä»Seuratå¯¹è±¡æå–å¿…è¦ä¿¡æ¯
extract_essential_data <- function(seurat_obj,
celltype_column = "cellType",
reduction = "umap.harmony",
output_file = NULL) {
cat("=== ä»Seuratå¯¹è±¡æå–å…³é”®ä¿¡æ¯ ===\n")
# æ£€æŸ¥è¾“å…¥
if (!inherits(seurat_obj, "Seurat")) {
stop("è¾“å…¥å¿…é¡»æ˜¯Seuratå¯¹è±¡")
}
# æ£€æŸ¥é™ç»´æ–¹æ³•æ˜¯å¦å­˜åœ¨
if (!reduction %in% names(seurat_obj@reductions)) {
available_reductions <- names(seurat_obj@reductions)
cat("å¯ç”¨çš„é™ç»´æ–¹æ³•:", paste(available_reductions, collapse = ", "), "\n")
stop("æŒ‡å®šçš„é™ç»´æ–¹æ³•ä¸å­˜åœ¨: ", reduction)
}
# æ£€æŸ¥ç»†èƒç±»å‹åˆ—æ˜¯å¦å­˜åœ¨
if (!celltype_column %in% colnames(seurat_obj@meta.data)) {
available_cols <- colnames(seurat_obj@meta.data)
cat("å¯ç”¨çš„meta.dataåˆ—:", paste(available_cols, collapse = ", "), "\n")
stop("æŒ‡å®šçš„ç»†èƒç±»å‹åˆ—ä¸å­˜åœ¨: ", celltype_column)
}
cat("åŸå§‹æ•°æ®ä¿¡æ¯:\n")
cat("- ç»†èƒæ•°:", ncol(seurat_obj), "\n")
cat("- åŸºå› æ•°:", nrow(seurat_obj), "\n")
cat("- ä½¿ç”¨é™ç»´æ–¹æ³•:", reduction, "\n")
cat("- ç»†èƒç±»å‹åˆ—:", celltype_column, "\n")
# æå–UMAPåæ ‡
umap_coords <- Embeddings(seurat_obj, reduction = reduction)
colnames(umap_coords) <- c("UMAP_1", "UMAP_2")  # æ ‡å‡†åŒ–åˆ—å
# æå–ç»†èƒç±»å‹
cell_metadata <- seurat_obj@meta.data
# åˆ›å»ºç²¾ç®€æ•°æ®æ¡†
essential_data <- data.frame(
cell_id = rownames(umap_coords),
UMAP_1 = umap_coords[, 1],
UMAP_2 = umap_coords[, 2],
cellType = as.character(cell_metadata[[celltype_column]]),
stringsAsFactors = FALSE
)
# æ·»åŠ å…¶ä»–å¯èƒ½æœ‰ç”¨çš„åˆ—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
useful_cols <- c("orig.ident", "seurat_clusters", "Phase", "percent.mt", "nCount_RNA", "nFeature_RNA")
existing_useful_cols <- intersect(useful_cols, colnames(cell_metadata))
if (length(existing_useful_cols) > 0) {
cat("é¢å¤–åŒ…å«çš„åˆ—:", paste(existing_useful_cols, collapse = ", "), "\n")
for (col in existing_useful_cols) {
essential_data[[col]] <- cell_metadata[[col]]
}
}
cat("æå–å®Œæˆï¼\n")
cat("ç²¾ç®€æ•°æ®ç»´åº¦:", nrow(essential_data), "Ã—", ncol(essential_data), "\n")
cat("ç»†èƒç±»å‹ç§ç±»:", length(unique(essential_data$cellType)), "\n")
# ä¿å­˜æ–‡ä»¶
if (!is.null(output_file)) {
write_tsv(essential_data, output_file)
file_size_mb <- round(file.info(output_file)$size / 1024^2, 2)
cat("å·²ä¿å­˜åˆ°:", output_file, "\n")
cat("æ–‡ä»¶å¤§å°:", file_size_mb, "MB\n")
# æ˜¾ç¤ºå‹ç¼©æ•ˆæœ
original_size_estimate <- object.size(seurat_obj)
compression_ratio <- round((1 - file.info(output_file)$size / as.numeric(original_size_estimate)) * 100, 1)
cat("ä¼°è®¡å‹ç¼©æ¯”ä¾‹:", compression_ratio, "%\n")
}
return(essential_data)
}
# ä¾¿æ·å‡½æ•°ï¼šæ‰¹é‡æå–å¤šä¸ªæ–‡ä»¶
batch_extract_essential_data <- function(rds_files,
celltype_column = "cellType",
reduction = "umap.harmony",
output_dir = "extracted_data") {
if (!dir.exists(output_dir)) {
dir.create(output_dir, recursive = TRUE)
}
for (rds_file in rds_files) {
cat("\nå¤„ç†æ–‡ä»¶:", rds_file, "\n")
# ç”Ÿæˆè¾“å‡ºæ–‡ä»¶å
base_name <- tools::file_path_sans_ext(basename(rds_file))
output_file <- file.path(output_dir, paste0(base_name, "_essential.tsv"))
tryCatch({
# åŠ è½½å¯¹è±¡
seurat_obj <- readRDS(rds_file)
# æå–æ•°æ®
extract_essential_data(
seurat_obj = seurat_obj,
celltype_column = celltype_column,
reduction = reduction,
output_file = output_file
)
}, error = function(e) {
cat("å¤„ç†å¤±è´¥:", e$message, "\n")
})
}
}
create_lightweight_cell_selector <- function(data_file = NULL) {
?slece_head()
?slice_head()
-log10(0.05)
-log10(0.01)
?gsub
aa <- "323 Ependymal NN"
gsub(" ", ".", aa)
splitCellsBy <- "cellType"
prefix <- "AP54_adjusted.cellbin"
subCellsTagIDs <- aa
subCellsTagIDs <- unlist(strsplit(subCellsTagIDs, ",")[[1]])
outPfx <- paste0("_", splitCellsBy, "_", gsub(" ", ".", subCellsTagIDs[1]))
outPfx
outPfx <- prefix
outPfx <- paste0(outPfx, "_", splitCellsBy, "_", gsub(" ", ".", subCellsTagIDs[1]))
outPfx
figPresentMode <- 1
grepl("1", figPresentMode)
grepl("2", figPresentMode)
figPresentMode <- "1"
grepl("1", figPresentMode)
figPresentMode <- "1,2"
grepl("2", figPresentMode)
grepl(2, figPresentMode)
?left_join()
library(dplyr)
?left_join()
?pivot_wider
library(biomaRt)
ensembl <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
ensembl
attributes <- c("ensembl_gene_id", "external_gene_name")
gene_table <- getBM(attributes = attributes, mart = ensembl)
View(gene_table)
gene_table[grepl("LOC", gene_table$external_gene_name),]
gene_table[gene_table$ensembl_gene_id == "ENSMUSG00000096873", ]
gene_table[gene_table$ensembl_gene_id == "ENSMUSG00000096873", ]
"ENSMUSG00000096873" %in% gene_table$ensembl_gene_id
"ENSMUSG00000064370"  %in% gene_table$ensembl_gene_id
gene_table[gene_table$ensembl_gene_id == "ENSMUSG00000064370", ]
gene_table[gene_table$ensembl_gene_id == "ENSMUSG00000064358", ]
gene_table[gene_table$ensembl_gene_id == "ENSMUSG00000064341", ]
View(gene_table)
write.table(gene_table, "E:/Project/reference/Mouse_gene_ensemblID_to_geneSymbol_table.tsv", sep="\t", quote=F, row.names=F)
gene_table[gene_table$external_gene_name == "",]
nrow(gene_table[gene_table$external_gene_name == "",])
gene_table[gene_table$external_gene_name == "",]$external_gene_name <- "Unknown"
write.table(gene_table, "E:/Project/reference/Mouse_gene_ensemblID_to_geneSymbol_table.tsv", sep="\t", quote=F, row.names=F)
library(pals)
nClsts <- 30
as.vector(c(alphabet(), alphabet2()))[1:nClsts]
as.vector(c(alphabet(), alphabet2()))[1:nClsts]
as.vector(c(alphabet(), alphabet2()))[1:nClsts]
as.vector(c(alphabet(), alphabet2()))[1:nClsts]
colorCodes <- as.vector(c(alphabet(), alphabet2()))
colorCodes
colorCodes [1]
length(clstColors)
clstColors <- as.vector(c(alphabet(), alphabet2()))
names(clstColors) <- seq(1, length(clstColors))
clstColors
df <- read.table("E:/Project/reference/Allen_ABC/Allen_ABC_subclass_annotation.tsv", head=T,sep="\t")
View(df)
library(dplyr)
head(df)
df <- df %>% select(subclass_id, subclass_id_label)
head(df)
# =============================================================================
# Step 1: Check and Install Development Tools
# =============================================================================
cat("\n[Step 1/6] Checking development tools...\n")
required_packages <- c("devtools", "roxygen2", "usethis", "pkgdown", "testthat", "gitcreds")
missing_packages <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]
if(length(missing_packages) > 0) {
cat("Installing missing packages:", paste(missing_packages, collapse = ", "), "\n")
install.packages(missing_packages, quiet = TRUE)
}
library(usethis, quietly = TRUE)
library(devtools, quietly = TRUE)
cat("âœ“ Development tools ready\n")
# =============================================================================
# Step 2: Create Package Structure
# =============================================================================
cat("\n[Step 2/6] Creating SmartX package structure...\n")
project_path <- "E:/Project/MySelfRpackages"
smartx_path <- file.path(project_path, "SmartX")
# Create directories if needed
if (!dir.exists(project_path)) {
dir.create(project_path, recursive = TRUE)
cat("âœ“ Created project directory:", project_path, "\n")
}
# Change to project directory
setwd(project_path)
# Create package (only if it doesn't exist)
if (!dir.exists(smartx_path)) {
create_package("SmartX", open = FALSE, rstudio = FALSE)
cat("âœ“ Package structure created\n")
} else {
cat("! Package directory already exists, skipping creation\n")
}
# Set working directory to package
setwd(smartx_path)
# =============================================================================
# Step 3: Setup Package Infrastructure
# =============================================================================
cat("\n[Step 3/6] Setting up package infrastructure...\n")
# License
tryCatch({
use_mit_license("Haitao Xiang")
cat("âœ“ MIT License added\n")
}, error = function(e) { cat("! License already exists\n") })
# Git
tryCatch({
use_git(message = "Initial commit: SmartX package structure")
cat("âœ“ Git initialized\n")
}, error = function(e) { cat("! Git already initialized or not available\n") })
# pkgdown
tryCatch({
use_pkgdown()
cat("âœ“ pkgdown configured\n")
}, error = function(e) { cat("! pkgdown already configured\n") })
# testthat
tryCatch({
use_testthat()
cat("âœ“ testthat configured\n")
}, error = function(e) { cat("! testthat already configured\n") })
# Vignette
tryCatch({
use_vignette("introduction", title = "Introduction to SMART-X")
cat("âœ“ Vignette created\n")
}, error = function(e) { cat("! Vignette already exists\n") })
# NEWS
tryCatch({
use_news_md()
cat("âœ“ NEWS.md created\n")
}, error = function(e) { cat("! NEWS.md already exists\n") })
# README
tryCatch({
use_readme_rmd()
cat("âœ“ README.Rmd created\n")
}, error = function(e) { cat("! README.Rmd already exists\n") })
# =============================================================================
# Step 4: Create R Source Files
# =============================================================================
cat("\n[Step 4/6] Creating R source file templates...\n")
r_files <- c("SmartX-package", "data_processing", "visualization",
"differential_analysis", "correlation_analysis",
"cellchat_wrapper", "spatial_analysis", "utils")
for (r_file in r_files) {
tryCatch({
use_r(r_file)
}, error = function(e) {})
}
cat("âœ“ R source files created\n")
# Create data-raw directory
tryCatch({
use_data_raw()
cat("âœ“ data-raw directory created\n")
}, error = function(e) { cat("! data-raw already exists\n") })
# Create inst directory
if (!dir.exists("inst/extdata")) {
dir.create("inst/extdata", recursive = TRUE, showWarnings = FALSE)
cat("âœ“ inst/extdata directory created\n")
}
# Create man/figures directory for logo
if (!dir.exists("man/figures")) {
dir.create("man/figures", recursive = TRUE, showWarnings = FALSE)
cat("âœ“ man/figures directory created\n")
}
# =============================================================================
# Step 5: Create DESCRIPTION File
# =============================================================================
cat("\n[Step 5/6] Creating DESCRIPTION file...\n")
description_content <- '
Package: SmartX
Type: Package
Title: Spatial-Multiomic Analysis and Research Toolkit for eXploration
Version: 0.1.0
Authors@R: c(
person("Haitao", "Xiang",
email = "dr.haitaoxiang@gmail.com",
role = c("aut", "cre"))
)
Description: SMART-X (Spatial-Multiomic Analysis and Research Toolkit for
eXploration) is a modular R framework for integrative analysis of
single-cell and spatial transcriptomics data. It provides streamlined
workflows for visualization, differential expression analysis, Gene
Ontology enrichment, spatial pattern discovery, and cell-cell
communication analysis.
License: MIT + file LICENSE
URL: https://github.com/Eric-htxiang/SmartX
BugReports: https://github.com/Eric-htxiang/SmartX/issues
Encoding: UTF-8
LazyData: true
Depends:
R (>= 4.0.0)
Imports:
Seurat (>= 4.0.0),
SeuratObject,
dplyr (>= 1.0.0),
ggplot2 (>= 3.3.0),
methods,
stats,
utils,
grid,
ggrepel,
patchwork,
reshape2,
pals
Suggests:
CellChat,
ComplexHeatmap,
enrichplot,
clusterProfiler,
org.Mm.eg.db,
org.Hs.eg.db,
knitr,
rmarkdown,
testthat (>= 3.0.0),
covr
RoxygenNote: 7.2.3
Roxygen: list(markdown = TRUE)
VignetteBuilder: knitr
biocViews:
SingleCell,
Spatial,
GeneExpression,
Visualization,
DifferentialExpression
'
writeLines(description_content, "DESCRIPTION")
cat("âœ“ DESCRIPTION file created\n")
# =============================================================================
# Step 6: Generate Documentation
# =============================================================================
cat("\n[Step 6/6] Generating package documentation...\n")
tryCatch({
document()
cat("âœ“ Documentation generated\n")
}, error = function(e) {
cat("! Documentation generation failed (need to add R code first)\n")
cat("  Error:", e$message, "\n")
})
# =============================================================================
# Summary and Next Steps
# =============================================================================
cat("\n")
cat("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
cat("â•‘                    âœ“ Setup Complete!                          â•‘\n")
cat("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
cat("\n")
cat("SmartX package structure has been created at:\n")
cat("  ğŸ“", smartx_path, "\n\n")
cat("Next steps:\n")
cat("  1. ğŸ“ Copy the R function code files to R/ directory\n")
cat("  2. ğŸ“„ Copy the README.Rmd content\n")
cat("  3. ğŸ”§ Run: devtools::document()\n")
cat("  4. âœ… Run: devtools::check()\n")
cat("  5. ğŸ“¦ Run: devtools::install()\n")
cat("\n")
cat("To setup GitHub:\n")
cat("  1. Create GitHub token: usethis::create_github_token()\n")
cat("  2. Save token: gitcreds::gitcreds_set()\n")
cat("  3. Connect to GitHub: usethis::use_github()\n")
cat("\n")
cat("To build package website:\n")
cat("  pkgdown::build_site()\n")
cat("\n")
# Save session information
writeLines(capture.output(sessionInfo()), "session_info.txt")
cat("Session info saved to: session_info.txt\n")
cat("\n")
cat("ğŸ‰ Congratulations! You can now start developing SmartX!\n")
cat("ğŸ“§ Questions? Contact: dr.haitaoxiang@gmail.com\n")
cat("\n")
# Open the directory in file explorer (Windows)
if (.Platform$OS.type == "windows") {
shell.exec(smartx_path)
cat("âœ“ Opened SmartX directory in File Explorer\n")
}
setwd("E:/Project/MySelfRpackages/SmartX")
getwd()
list.files()
library(devtools)
document()
install()
library(SmartX)
?drawUMAP
library(SmartX)
